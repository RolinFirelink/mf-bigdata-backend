<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.arg.smart.web.statistics.mapper.BuyersIndexMapper">

	<!--获取一个采购商的采购商指数-->
	<select id="selectOneBuyerIndex" resultType="com.arg.smart.web.statistics.vo.BuyersIndexVO">
		SELECT sum(n1.purchase_nums) * avg(p1.average_price) /
# 		       上个月这个采购商所有采购货品与货品价格乘积总和
		       (SELECT sum(n.purchase_nums) * avg(p.average_price)
		        FROM sh_product_market_nums AS n
			             LEFT JOIN sh_product_market_price AS p
			                       ON n.name = p.name
		        WHERE substr(p.record_date, 1, 7)
		                  = concat(if(#{month} - 1 = 0, #{year} - 1, #{year}), '-', lpad(if(#{month} - 1 = 0, '12', #{month}), 2, '0'))
			      AND n.publisher = #{name}
		        GROUP BY n.name) AS buyer_index
		FROM sh_product_market_nums AS n1
			     LEFT JOIN sh_product_market_price AS p1
			               ON n1.name = p1.name
		WHERE substr(p1.record_date, 1, 7) = concat(#{year}, '-', lpad(#{month}, 2, '0'))
		  AND n1.publisher = #{name}
		GROUP BY n1.name;
	</select>

	<!--获取某模块某年某月所有采购商名称-->
	<select id="selectBuyersName" resultType="java.lang.String">
		SELECT publisher FROM sh_product_market_nums WHERE flag = #{flag} AND substr(create_time, 1, 7)
		                                                                          = concat(#{year}, '-', lpad(#{month}, 2, '0'));
	</select>

</mapper>
